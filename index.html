<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PranaMap | Energy Healing Intake System</title>
    <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background-color: #fff;
            border-bottom: 1px solid #e0e0e0;
            padding: 1.25rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            letter-spacing: 0.5px;
        }

        .logo span {
            font-weight: 300;
            color: #7f8c8d;
        }

        nav {
            display: flex;
            gap: 2rem;
        }

        nav a {
            text-decoration: none;
            color: #7f8c8d;
            font-size: 0.9rem;
            transition: color 0.2s ease;
        }

        nav a:hover {
            color: #2c3e50;
        }

        main {
            flex: 1;
            display: flex;
            padding: 2rem;
            gap: 2rem;
        }

        .viewer-container {
            flex: 2;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: relative;
            min-height: 600px;
            overflow: hidden;
        }

        .viewer-instructions {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            background: rgba(255,255,255,0.95);
            padding: 0.75rem 1rem;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #7f8c8d;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }

        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 1.5rem;
        }

        .card h2 {
            font-size: 1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #eee;
        }

        .chakra-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .chakra-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border: 1px solid transparent;
        }

        .chakra-item:hover {
            background-color: #f8f9fa;
        }

        .chakra-item.selected {
            background-color: #f0f4f8;
            border-color: #d0d9e0;
        }

        .chakra-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.75rem;
        }

        .chakra-name {
            font-size: 0.9rem;
            color: #2c3e50;
            flex: 1;
        }

        .chakra-sanskrit {
            font-size: 0.75rem;
            color: #95a5a6;
            font-style: italic;
        }

        .chakra-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #e0e0e0;
            margin-left: 0.5rem;
        }

        .chakra-status.marked {
            background-color: #e74c3c;
        }

        .selected-info {
            display: none;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }

        .selected-info.visible {
            display: block;
        }

        .selected-info h3 {
            font-size: 0.95rem;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .selected-info p {
            font-size: 0.85rem;
            color: #7f8c8d;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .intensity-label {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-bottom: 0.5rem;
        }

        .intensity-slider {
            width: 100%;
            margin-bottom: 1rem;
        }

        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.85rem;
            resize: vertical;
            min-height: 80px;
            transition: border-color 0.2s ease;
        }

        textarea:focus {
            outline: none;
            border-color: #bdc3c7;
        }

        textarea::placeholder {
            color: #bdc3c7;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 0.5rem;
        }

        .btn-primary {
            background-color: #2c3e50;
            color: #fff;
        }

        .btn-primary:hover {
            background-color: #34495e;
        }

        .btn-secondary {
            background-color: #ecf0f1;
            color: #2c3e50;
        }

        .btn-secondary:hover {
            background-color: #d5dbdb;
        }

        .acupoint-reference {
            font-size: 0.75rem;
            color: #95a5a6;
            margin-top: 0.25rem;
        }

        #canvas-container {
            width: 100%;
            height: 100%;
        }

        footer {
            background-color: #fff;
            border-top: 1px solid #e0e0e0;
            padding: 1rem 2rem;
            text-align: center;
            font-size: 0.8rem;
            color: #95a5a6;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">Prana<span>Map</span></div>
        <nav>
            <a href="#" class="active">Patient Intake</a>
            <a href="#">Session History</a>
            <a href="#">About</a>
        </nav>
    </header>

    <main>
        <div class="viewer-container">
            <div id="canvas-container"></div>
            <div class="lotus-backdrop">
                <svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
                    <!-- Center petal -->
                    <ellipse cx="200" cy="150" rx="25" ry="70" fill="#d4af37" opacity="0.12"/>
                    <!-- Inner petals -->
                    <ellipse cx="200" cy="150" rx="25" ry="70" fill="#d4af37" opacity="0.10" transform="rotate(-15, 200, 150)"/>
                    <ellipse cx="200" cy="150" rx="25" ry="70" fill="#d4af37" opacity="0.10" transform="rotate(15, 200, 150)"/>
                    <ellipse cx="200" cy="150" rx="25" ry="70" fill="#d4af37" opacity="0.08" transform="rotate(-30, 200, 150)"/>
                    <ellipse cx="200" cy="150" rx="25" ry="70" fill="#d4af37" opacity="0.08" transform="rotate(30, 200, 150)"/>
                    <!-- Middle petals -->
                    <ellipse cx="200" cy="150" rx="30" ry="85" fill="#d4af37" opacity="0.07" transform="rotate(-45, 200, 150)"/>
                    <ellipse cx="200" cy="150" rx="30" ry="85" fill="#d4af37" opacity="0.07" transform="rotate(45, 200, 150)"/>
                    <ellipse cx="200" cy="150" rx="30" ry="85" fill="#d4af37" opacity="0.06" transform="rotate(-60, 200, 150)"/>
                    <ellipse cx="200" cy="150" rx="30" ry="85" fill="#d4af37" opacity="0.06" transform="rotate(60, 200, 150)"/>
                    <!-- Outer petals -->
                    <ellipse cx="200" cy="150" rx="35" ry="100" fill="#d4af37" opacity="0.05" transform="rotate(-75, 200, 150)"/>
                    <ellipse cx="200" cy="150" rx="35" ry="100" fill="#d4af37" opacity="0.05" transform="rotate(75, 200, 150)"/>
                    <ellipse cx="200" cy="150" rx="35" ry="100" fill="#d4af37" opacity="0.04" transform="rotate(-90, 200, 150)"/>
                    <!-- Base petals (horizontal) -->
                    <ellipse cx="200" cy="180" rx="50" ry="20" fill="#d4af37" opacity="0.08"/>
                    <ellipse cx="160" cy="175" rx="40" ry="15" fill="#d4af37" opacity="0.06" transform="rotate(-10, 160, 175)"/>
                    <ellipse cx="240" cy="175" rx="40" ry="15" fill="#d4af37" opacity="0.06" transform="rotate(10, 240, 175)"/>
                </svg>
            </div>
            <div class="loading-indicator" id="loading-indicator">Loading model...</div>
            <div class="viewer-instructions">
                Click and drag to rotate. Scroll to zoom. Click a chakra point to select.
            </div>
        </div>

        <div class="panel">
            <div class="card">
                <h2>Energy Centers</h2>
                <ul class="chakra-list" id="chakra-list"></ul>
                
                <div class="selected-info" id="selected-info">
                    <h3 id="selected-name"></h3>
                    <p id="selected-description"></p>
                    <p class="acupoint-reference" id="selected-acupoint"></p>
                    
                    <label class="intensity-label">Intensity of imbalance felt</label>
                    <input type="range" class="intensity-slider" id="intensity-slider" min="1" max="10" value="5">
                    
                    <textarea id="notes-input" placeholder="Describe what you are experiencing in this area..."></textarea>
                    
                    <button class="btn btn-primary" id="mark-btn">Mark as Area of Concern</button>
                </div>
            </div>

            <div class="card">
                <h2>Session Summary</h2>
                <p id="summary-text" style="font-size: 0.85rem; color: #7f8c8d;">
                    No areas marked yet. Select chakra points on the figure or from the list to indicate areas where you feel energetic imbalance.
                </p>
                <button class="btn btn-secondary" id="clear-btn" style="display: none;">Clear All</button>
                <button class="btn btn-primary" id="submit-btn" style="display: none; margin-left: 0.5rem;">Submit to Practitioner</button>
            </div>
        </div>
    </main>

    <footer>
        PranaMap — Energy Healing Intake System. Inspired by bioelectric field research.
    </footer>

    <script>
        // Chakra data with traditional colors
        const chakraData = [
            {
                id: 'crown',
                name: 'Crown',
                sanskrit: 'Sahasrara',
                color: 0x9c27b0,
                position: { x: 0, y: 18.5, z: 0 },
                description: 'Spiritual connection, higher consciousness, enlightenment, and unity with the divine.',
                acupoint: 'Correlates to GV20 (Bai Hui) — Point of energy union measured at top of head'
            },
            {
                id: 'third-eye',
                name: 'Third Eye',
                sanskrit: 'Ajna',
                color: 0x3f51b5,
                position: { x: 0, y: 17.2, z: 1.2 },
                description: 'Intuition, inner wisdom, insight, and perception beyond ordinary sight.',
                acupoint: 'Located between the eyebrows, associated with pineal gland function'
            },
            {
                id: 'throat',
                name: 'Throat',
                sanskrit: 'Vishuddha',
                color: 0x2196f3,
                position: { x: 0, y: 15.5, z: 0.8 },
                description: 'Communication, self-expression, truth, and authenticity.',
                acupoint: 'Thyroid region, connected to expression and metabolism'
            },
            {
                id: 'heart',
                name: 'Heart',
                sanskrit: 'Anahata',
                color: 0x4caf50,
                position: { x: 0, y: 13.8, z: 1.0 },
                description: 'Love, compassion, emotional balance, and connection to others.',
                acupoint: 'Correlates to HT7 — Heart meridian measurement point'
            },
            {
                id: 'solar-plexus',
                name: 'Solar Plexus',
                sanskrit: 'Manipura',
                color: 0xffeb3b,
                position: { x: 0, y: 12.0, z: 1.2 },
                description: 'Personal power, confidence, willpower, and self-esteem.',
                acupoint: 'Correlates to CT12 — Solar plexus measurement point'
            },
            {
                id: 'sacral',
                name: 'Sacral',
                sanskrit: 'Svadhisthana',
                color: 0xff9800,
                position: { x: 0, y: 10.2, z: 1.0 },
                description: 'Creativity, emotions, sensuality, pleasure, and adaptability.',
                acupoint: 'Lower abdominal region, connected to reproductive and digestive systems'
            },
            {
                id: 'root',
                name: 'Root',
                sanskrit: 'Muladhara',
                color: 0xf44336,
                position: { x: 0, y: 8.5, z: 0.5 },
                description: 'Grounding, survival, security, and physical vitality.',
                acupoint: 'Base of spine, correlates to BL24 — Bladder meridian points (lumbar region)'
            }
        ];

        // Application state
        let selectedChakra = null;
        let markedChakras = {};
        let scene, camera, renderer, humanGroup, humanModel;
        let chakraMeshes = {};
        let isDragging = false;
        let prevMouseX = 0, prevMouseY = 0;

        // Initialize Three.js scene
        function initScene() {
            const container = document.getElementById('canvas-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xffffff);

            camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
            camera.position.set(0, 13, 45);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(width, height);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 20, 15);
            scene.add(directionalLight);

            const backLight = new THREE.DirectionalLight(0xffffff, 0.4);
            backLight.position.set(-10, 10, -10);
            scene.add(backLight);

            const fillLight = new THREE.DirectionalLight(0xffffff, 0.3);
            fillLight.position.set(0, 5, 20);
            scene.add(fillLight);

            // Create group for human and chakras
            humanGroup = new THREE.Group();
            scene.add(humanGroup);

            // Load the GLB model
            loadHumanModel();

            // Event listeners
            renderer.domElement.addEventListener('mousedown', onMouseDown);
            renderer.domElement.addEventListener('mousemove', onMouseMove);
            renderer.domElement.addEventListener('mouseup', onMouseUp);
            renderer.domElement.addEventListener('wheel', onMouseWheel);
            renderer.domElement.addEventListener('click', onCanvasClick);
            window.addEventListener('resize', onWindowResize);

            animate();
        }

        function loadHumanModel() {
            const loader = new THREE.GLTFLoader();
            
            loader.load(
                'pranamap-figure.glb',
                function (gltf) {
                    humanModel = gltf.scene;
                    
                    // Make the model translucent
                    humanModel.traverse(function (child) {
                        if (child.isMesh) {
                            child.material = new THREE.MeshPhongMaterial({
                                color: 0xc9b8a8,
                                transparent: true,
                                opacity: 0.6,
                                side: THREE.DoubleSide,
                                depthWrite: false
                            });
                        }
                    });

                    humanGroup.add(humanModel);
                    
                    // Create chakra points after model is loaded
                    createChakraPoints();
                    
                    // Hide loading indicator
                    document.getElementById('loading-indicator').style.display = 'none';
                },
                function (xhr) {
                    const percent = (xhr.loaded / xhr.total * 100).toFixed(0);
                    document.getElementById('loading-indicator').textContent = 'Loading model... ' + percent + '%';
                },
                function (error) {
                    console.error('Error loading model:', error);
                    document.getElementById('loading-indicator').textContent = 'Error loading model. Please refresh.';
                }
            );
        }

        function createChakraPoints() {
            chakraData.forEach(chakra => {
                // Outer glow sphere - reduced size
                const glowGeometry = new THREE.SphereGeometry(0.35, 32, 32);
                const glowMaterial = new THREE.MeshBasicMaterial({
                    color: chakra.color,
                    transparent: true,
                    opacity: 0.35
                });
                const glowSphere = new THREE.Mesh(glowGeometry, glowMaterial);

                // Inner core sphere - reduced size
                const coreGeometry = new THREE.SphereGeometry(0.18, 32, 32);
                const coreMaterial = new THREE.MeshBasicMaterial({
                    color: chakra.color,
                    transparent: true,
                    opacity: 0.95
                });
                const coreSphere = new THREE.Mesh(coreGeometry, coreMaterial);

                // Group them
                const chakraGroup = new THREE.Group();
                chakraGroup.add(glowSphere);
                chakraGroup.add(coreSphere);
                chakraGroup.position.set(
                    chakra.position.x,
                    chakra.position.y,
                    chakra.position.z
                );
                chakraGroup.userData = { chakraId: chakra.id };

                humanGroup.add(chakraGroup);
                chakraMeshes[chakra.id] = {
                    group: chakraGroup,
                    glow: glowSphere,
                    core: coreSphere,
                    originalScale: 1
                };
            });
        }

        function animate() {
            requestAnimationFrame(animate);

            // Subtle pulsing animation for chakra points
            const time = Date.now() * 0.002;
            Object.keys(chakraMeshes).forEach((id, index) => {
                const mesh = chakraMeshes[id];
                const pulse = 1 + Math.sin(time + index * 0.5) * 0.15;
                const baseScale = markedChakras[id] ? 1.4 : 1;
                mesh.glow.scale.setScalar(pulse * baseScale);
            });

            renderer.render(scene, camera);
        }

        function onMouseDown(e) {
            isDragging = true;
            prevMouseX = e.clientX;
            prevMouseY = e.clientY;
        }

        function onMouseMove(e) {
            if (!isDragging) return;

            const deltaX = e.clientX - prevMouseX;
            const deltaY = e.clientY - prevMouseY;

            humanGroup.rotation.y += deltaX * 0.01;
            humanGroup.rotation.x += deltaY * 0.005;
            humanGroup.rotation.x = Math.max(-0.5, Math.min(0.5, humanGroup.rotation.x));

            prevMouseX = e.clientX;
            prevMouseY = e.clientY;
        }

        function onMouseUp() {
            isDragging = false;
        }

        function onMouseWheel(e) {
            e.preventDefault();
            camera.position.z += e.deltaY * 0.05;
            camera.position.z = Math.max(25, Math.min(80, camera.position.z));
        }

        function onCanvasClick(e) {
            if (Math.abs(e.clientX - prevMouseX) > 5 || Math.abs(e.clientY - prevMouseY) > 5) return;

            const rect = renderer.domElement.getBoundingClientRect();
            const mouse = new THREE.Vector2(
                ((e.clientX - rect.left) / rect.width) * 2 - 1,
                -((e.clientY - rect.top) / rect.height) * 2 + 1
            );

            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);

            const chakraObjects = [];
            Object.values(chakraMeshes).forEach(m => {
                chakraObjects.push(m.glow, m.core);
            });

            const intersects = raycaster.intersectObjects(chakraObjects);

            if (intersects.length > 0) {
                const clickedObject = intersects[0].object;
                const chakraGroup = clickedObject.parent;
                const chakraId = chakraGroup.userData.chakraId;
                if (chakraId) {
                    selectChakra(chakraId);
                }
            }
        }

        function onWindowResize() {
            const container = document.getElementById('canvas-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        }

        // UI Functions
        function buildChakraList() {
            const list = document.getElementById('chakra-list');
            list.innerHTML = '';

            chakraData.forEach(chakra => {
                const li = document.createElement('li');
                li.className = 'chakra-item';
                li.dataset.chakraId = chakra.id;

                const colorHex = '#' + chakra.color.toString(16).padStart(6, '0');

                li.innerHTML = `
                    <div class="chakra-indicator" style="background-color: ${colorHex}"></div>
                    <span class="chakra-name">${chakra.name}</span>
                    <span class="chakra-sanskrit">${chakra.sanskrit}</span>
                    <div class="chakra-status" id="status-${chakra.id}"></div>
                `;

                li.addEventListener('click', () => selectChakra(chakra.id));
                list.appendChild(li);
            });
        }

        function selectChakra(chakraId) {
            selectedChakra = chakraData.find(c => c.id === chakraId);

            // Update list selection
            document.querySelectorAll('.chakra-item').forEach(item => {
                item.classList.toggle('selected', item.dataset.chakraId === chakraId);
            });

            // Update info panel
            const infoPanel = document.getElementById('selected-info');
            infoPanel.classList.add('visible');

            document.getElementById('selected-name').textContent = 
                `${selectedChakra.name} — ${selectedChakra.sanskrit}`;
            document.getElementById('selected-description').textContent = 
                selectedChakra.description;
            document.getElementById('selected-acupoint').textContent = 
                selectedChakra.acupoint;

            // Load existing data if marked
            if (markedChakras[chakraId]) {
                document.getElementById('intensity-slider').value = markedChakras[chakraId].intensity;
                document.getElementById('notes-input').value = markedChakras[chakraId].notes;
                document.getElementById('mark-btn').textContent = 'Update Concern';
            } else {
                document.getElementById('intensity-slider').value = 5;
                document.getElementById('notes-input').value = '';
                document.getElementById('mark-btn').textContent = 'Mark as Area of Concern';
            }

            // Highlight in 3D view
            Object.keys(chakraMeshes).forEach(id => {
                const mesh = chakraMeshes[id];
                if (id === chakraId) {
                    mesh.core.material.opacity = 1;
                    mesh.glow.material.opacity = 0.5;
                } else {
                    mesh.core.material.opacity = 0.95;
                    mesh.glow.material.opacity = 0.35;
                }
            });
        }

        function markChakra() {
            if (!selectedChakra) return;

            const intensity = document.getElementById('intensity-slider').value;
            const notes = document.getElementById('notes-input').value;

            markedChakras[selectedChakra.id] = {
                name: selectedChakra.name,
                sanskrit: selectedChakra.sanskrit,
                intensity: intensity,
                notes: notes,
                timestamp: new Date().toISOString()
            };

            // Update status indicator
            document.getElementById(`status-${selectedChakra.id}`).classList.add('marked');

            // Update 3D visualization
            const mesh = chakraMeshes[selectedChakra.id];
            mesh.glow.material.opacity = 0.6;
            mesh.core.scale.setScalar(1.3);

            document.getElementById('mark-btn').textContent = 'Update Concern';

            updateSummary();
        }

        function updateSummary() {
            const summaryText = document.getElementById('summary-text');
            const clearBtn = document.getElementById('clear-btn');
            const submitBtn = document.getElementById('submit-btn');

            const markedCount = Object.keys(markedChakras).length;

            if (markedCount === 0) {
                summaryText.textContent = 'No areas marked yet. Select chakra points on the figure or from the list to indicate areas where you feel energetic imbalance.';
                clearBtn.style.display = 'none';
                submitBtn.style.display = 'none';
            } else {
                const areas = Object.values(markedChakras)
                    .map(c => `${c.name} (intensity: ${c.intensity}/10)`)
                    .join(', ');
                summaryText.textContent = `Areas of concern: ${areas}`;
                clearBtn.style.display = 'inline-block';
                submitBtn.style.display = 'inline-block';
            }
        }

        function clearAll() {
            markedChakras = {};
            
            document.querySelectorAll('.chakra-status').forEach(el => {
                el.classList.remove('marked');
            });

            Object.values(chakraMeshes).forEach(mesh => {
                mesh.glow.material.opacity = 0.35;
                mesh.core.scale.setScalar(1);
            });

            document.getElementById('selected-info').classList.remove('visible');
            selectedChakra = null;

            document.querySelectorAll('.chakra-item').forEach(item => {
                item.classList.remove('selected');
            });

            updateSummary();
        }

        function submitIntake() {
            const intakeData = {
                timestamp: new Date().toISOString(),
                concerns: markedChakras
            };

            console.log('Intake data to submit:', intakeData);
            alert('Intake submitted successfully. Your practitioner will review your concerns before your session.');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initScene();
            buildChakraList();

            document.getElementById('mark-btn').addEventListener('click', markChakra);
            document.getElementById('clear-btn').addEventListener('click', clearAll);
            document.getElementById('submit-btn').addEventListener('click', submitIntake);
        });
    </script>
</body>
</html>
